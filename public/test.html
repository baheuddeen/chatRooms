<!DOCTYPE html>
<html>

<head>
    <title>WebRTC Test</title>
</head>

<body>
    <h2>WebRTC Offer/Answer Test</h2>

    <textarea id="offer" placeholder="Copy offer here" rows="5" cols="60"></textarea>
    <button id="createOffer">Create Offer</button>
    <button id="setOffer">Set Offer</button>

    <br><br>

    <textarea id="answer" placeholder="Copy answer here" rows="5" cols="60"></textarea>
    <button id="createAnswer">Create Answer</button>
    <button id="setAnswer">Set Answer</button>

    <video id="localVideo" autoplay playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        let localPeer = null;
        let remotePeer = null;

        // Assuming you have video elements in your HTML for local and remote videos
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');

        // Helper function to start media stream
        async function startMedia() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = stream;
                return stream;
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }
        }

        document.getElementById('createOffer').addEventListener('click', async () => {
            localPeer = new RTCPeerConnection({
                configuration: {
                    iceServers: [
                    { urls: 'stun:wee-whisper.com:3478'},
                    { urls: 'turn:wee-whisper.com:3478', username: 'turnusesr', credential: '123456'},

                    ]
                }
            });

            const stream = await startMedia();
            stream.getTracks().forEach(track => localPeer.addTrack(track, stream));

            localPeer.ontrack = event => {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            localPeer.onicecandidate = event => {
                if (event.candidate === null) {
                    document.getElementById('offer').value = JSON.stringify(localPeer.localDescription);
                }
            };

            const offer = await localPeer.createOffer();
            await localPeer.setLocalDescription(offer);
        });

        document.getElementById('setOffer').addEventListener('click', async () => {
            const offer = JSON.parse(document.getElementById('offer').value);
            remotePeer = new RTCPeerConnection({
                configuration: {
                    iceServers: [
                    { urls: 'stun:wee-whisper.com:3478'},
                    { urls: 'turn:wee-whisper.com:3478', username: 'turnusesr', credential: '123456'},
                    ]
                }
            });

            remotePeer.ontrack = event => {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            remotePeer.onicecandidate = event => {
                if (event.candidate === null) {
                    document.getElementById('answer').value = JSON.stringify(remotePeer.localDescription);
                }
            };

            await remotePeer.setRemoteDescription(offer);
            const stream = await startMedia();
            stream.getTracks().forEach(track => remotePeer.addTrack(track, stream));

            const answer = await remotePeer.createAnswer();
            await remotePeer.setLocalDescription(answer);
        });

        document.getElementById('setAnswer').addEventListener('click', async () => {
            const answer = JSON.parse(document.getElementById('answer').value);
            await localPeer.setRemoteDescription(answer);
        });

    </script>
</body>

</html>